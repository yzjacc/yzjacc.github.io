---
layout: post
title: "「Node」Node API篇"
subtitle: " From Yuzj"
author: "Yuzj"
header-img: "img/post-bg-web.jpg"
header-mask: 0.3
catalog: true
tags:
- 后端
- NodeJS
---

### 参考网址 http://nodejs.cn/api/

### 网络

#### 1.协议

![屏幕快照 2019-11-19 下午7.25.17](https://pg12138.oss-cn-beijing.aliyuncs.com/img/in-post/2019-12-2/屏幕快照 2019-11-19 下午7.25.17.png)

协议是一种格式，TCP/IP协议相当于0101010 包裹在HTTP协议之外

#### 2.数据交互

![屏幕快照 2019-11-19 下午7.27.25](https://pg12138.oss-cn-beijing.aliyuncs.com/img/in-post/2019-12-2/屏幕快照 2019-11-19 下午7.27.25.png)

NET所处的是TCP/IP这层

发信息的人相当于Client客户端 接收信息的人Server服务端 

通常Client中是和Socket功能在一起写

NET模块既能创建出Socket 也能创建出Server

### 服务器

#### 1.Server Socket事件 属性

![屏幕快照 2019-11-19 下午7.42.19](https://pg12138.oss-cn-beijing.aliyuncs.com/img/in-post/2019-12-2/屏幕快照 2019-11-19 下午7.50.50.png)

```js
// server端 
var net = require("net");

var server = net.createServer();
server.listen(12306, "127.0.0.1");//监听ip 端口
// console.log(server.address());
server.on("listening", function () {
    console.log("服务已启动");
});
//
// server.on("connection", function (socket) {
//     console.log("有新的连接");
// 
//     socket.on("data", function (data) {
//         console.log(data.toString());
//				 socket.write("hello client");
//     });
//
//     socket.on("close", function () {
//         console.log("客户端已关闭");
//         server.close();
//     });
//
// });
//
// server.on("close", function () {
//     console.log("服务已关闭");
// });
```

```js
// socket端 
var net = require("net");

var socket = net.connect(12306, "127.0.0.1");//连接ip 端口

socket.setTimeout(2000);

socket.on("connect", function () {
   console.log("已连接到服务器");
   console.log(socket.remoteAddress);
   console.log(socket.remotePort);
   console.log(socket.localAddress);
   console.log(socket.localPort);
});
socket.on("timeout", function() {
   console.log("超时啦");
   socket.end();
});
//
// socket.on("data", function(data) {
//     console.log(data.toString());
//     socket.end();
// });
//
// socket.on("close", function () {
//     console.log("连接已关闭");
// });

socket.write("hello server");
```

#### 2.服务器关闭的功能 

mac : ps aux|grep "node" kill id

webstrom 点红色关闭键

windows 任务管理器关闭

#### 3.服务器接受发送http 请求

```js
var net = require("net");

var server = net.createServer();
server.listen(12306, "127.0.0.1");

server.on("listening", function () {
    console.log("服务已启动");
});

server.on("connection", function (socket) {
    console.log("有新的连接");
    socket.on("data", function (data) {
      	// data.toString()是http请求头
        var request = data.toString().split("\r\n");
        var url = request[0].split(" ")[1];
        console.log(url);
      	// 往回写也得按照相应头格式写
        // socket.write("HTTP 200OK\r\nContent-type:text/html\r\nServer:DWS/1.1\r\n\r\n<html><body>hello browser</body></html>");
    });
});

```

#### 4.服务器读取本机对应页面

```js
//server.js

var net  = require("net");//网络层和运输层   TCP/IP协议
var fs = require("fs");
var globalConf = require("./conf");

var server = net.createServer();
server.listen(globalConf.port, "127.0.0.1");

server.on("listening", function () {
    console.log("服务已启动");
});

server.on("connection", function(socket) {
    socket.on("data", function (data) {
      
        console.log(data.toString());

        var url = data.toString().split("\r\n")[0].split(" ")[1];
        try {
            var dataFile = fs.readFileSync(globalConf["basePath"] + url);
            socket.write("HTTP/1.1 200OK\r\n\r\n");
            socket.write(dataFile);
        } catch (e) {
            socket.write("HTTP/1.1 404NotFound\r\n\r\n<html><body><h1>404 Not Found</h1></body></html>");
        }
        socket.end();
    });
});
```

```js
// conf.js
var fs = require("fs");

//加载配置文件
var globalConf = {};
var conf = fs.readFileSync("server.conf");//同步读取文件
var confs = conf.toString().split("\n");
for (var i = 0 ; i < confs.length ; i ++) {
    var tempConf = confs[i].split("=");
    if (tempConf.length < 2) {
        continue;
    } else {
        globalConf[tempConf[0]] = tempConf[1];
    }
}
if (globalConf["path_position"] == "relative") {
    globalConf.basePath = __dirname + globalConf.path;
} else {
    globalConf.basePath = globalConf.path;
}

module.exports = globalConf;
```

```conf
// server.conf
port=12306
path=/Users/changlifeng/Desktop/web
path_position=absolute
```

#### 5.http模块使用

源码在Demo NodeJS NodeLesson7https://www.cmdy5.com/play/33834.html?33834-1-1

#### 6.log 日志

```js
// log.js

var fs = require("fs");
var globalConfig = require("./config");

var fileName = globalConfig.log_path + globalConfig.log_name;

// 一件事与其他事没有必然联系时采用异步 
// fs.writeFile(fileName,"hdjw",function({})) 异步
// fs.writeFileSync(fileName,"hdjw",function({})) 同步

function log(data) {

    console.log(data);
    // flag:"a" 追加写入
    // fs.writeFile(fileName,data + '\n',{flag:"a"},function({
    //    console.log("finsh");
    //}))

    // appendFile 默认追加写入
    fs.appendFile(fileName, data + "\n" , function () {});

}

module.exports = log;
```

![屏幕快照 2019-11-20 上午10.09.23](https://pg12138.oss-cn-beijing.aliyuncs.com/img/in-post/2019-12-2/屏幕快照 2019-11-20 上午10.09.23.png)

红色常用 蓝色不常用

 ![屏幕快照 2019-11-21 下午6.11.22](https://pg12138.oss-cn-beijing.aliyuncs.com/img/in-post/2019-12-2/屏幕快照 2019-11-21 下午6.11.22.png)